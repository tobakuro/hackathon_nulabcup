{
  "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/0.16.0/.schema/devbox.schema.json",
  "packages": [
    "nodejs@24",
    "go@1.26",
    "postgresql@17.8",
    "redis@8.2.3",
    "air@latest",
    "golangci-lint@latest",
    "sqlc@latest",
    "goose@latest",
    "lefthook@latest"
  ],
  "env": {
    "PGDATA": "$HOME/.local/share/hackathon_nulabcup/postgresql/data",
    "PGHOST": "/tmp"
  },
  "shell": {
    "init_hook": [
      "if [ ! -d \"$PGDATA\" ] || [ -z \"$(ls -A \"$PGDATA\" 2>/dev/null)\" ]; then echo 'Initializing PostgreSQL...'; initdb -D \"$PGDATA\" --no-locale --encoding=UTF8; grep -qF \"listen_addresses = ''\" \"$PGDATA/postgresql.auto.conf\" 2>/dev/null || echo \"listen_addresses = ''\" >> \"$PGDATA/postgresql.auto.conf\"; fi",
      "mkdir -p /tmp/redis-devbox",
      "export PGHOST=/tmp",
      "export GOOSE_DRIVER=postgres",
      "export GOOSE_DBSTRING=\"host=${PGHOST} user=${USER} dbname=hackathon sslmode=disable\"",
      "export GOOSE_MIGRATION_DIR=${DEVBOX_PROJECT_ROOT}/backend/db/migrations"
    ],
    "scripts": {
      "setup": [
        "echo ':rocket: Starting services...'",
        "devbox services start",
        "echo ':package: Installing frontend dependencies...'",
        "cd frontend && npm install",
        "echo ':file_cabinet:  Setting up database...'",
        "devbox run db:setup",
        "echo ':white_check_mark: Setup complete! Run \"devbox run backend:dev\" and \"devbox run frontend:dev\" to start.'"
      ],
      "db:setup": [
        "echo 'PostgreSQLの起動を待っています...'; for i in $(seq 1 60); do pg_isready -h \"$PGHOST\" -q && break; sleep 1; printf '.'; done; echo ''",
        "if ! psql -h \"$PGHOST\" -lqt 2>/dev/null | cut -d '|' -f 1 | grep -qw hackathon; then createdb -h \"$PGHOST\" hackathon && echo 'Created database: hackathon'; else echo 'Database hackathon already exists'; fi",
        "GOOSE_DRIVER=postgres GOOSE_DBSTRING=\"host=${PGHOST} user=${USER} dbname=hackathon sslmode=disable\" GOOSE_MIGRATION_DIR=${DEVBOX_PROJECT_ROOT}/backend/db/migrations goose up && echo 'All goose migrations applied.'",
        "cd ${DEVBOX_PROJECT_ROOT}/frontend && npx drizzle-kit migrate && echo 'All drizzle migrations applied.'"
      ],
      "backend:dev": [
        "cd backend && air"
      ],
      "backend:run": [
        "cd backend && go run ./cmd/server"
      ],
      "backend:build": [
        "cd backend && go build -o bin/server ./cmd/server"
      ],
      "frontend:dev": [
        "cd frontend && npm run dev"
      ],
      "frontend:install": [
        "cd frontend && npm install"
      ],
      "frontend:drizzle": [
        "cd frontend && npx drizzle-kit studio"
      ],
      "sqlc:generate": [
        "cd backend/db && sqlc generate"
      ],
      "backend:lint": [
        "cd backend && golangci-lint run ./..."
      ],
      "frontend:check": [
        "cd frontend && npm run format && npm run lint:fix && npm run typecheck && npm run build"
      ]
    }
  }
}
