{
  "$schema": "https://raw.githubusercontent.com/jetify-com/devbox/0.16.0/.schema/devbox.schema.json",
  "packages": [
    "nodejs@24",
    "go@1.26",
    "postgresql@17.8",
    "redis@8.2.3",
    "air@latest",
    "golangci-lint@latest",
    "sqlc@latest",
    "go-migrate@latest"
  ],
  "shell": {
    "init_hook": [
      "if [ ! -d \"$PGDATA\" ] || [ -z \"$(ls -A \"$PGDATA\" 2>/dev/null)\" ]; then echo 'Initializing PostgreSQL...'; initdb -D \"$PGDATA\" --no-locale --encoding=UTF8; grep -qF \"listen_addresses = ''\" \"$PGDATA/postgresql.auto.conf\" 2>/dev/null || echo \"listen_addresses = ''\" >> \"$PGDATA/postgresql.auto.conf\"; fi",
      "mkdir -p /tmp/redis-devbox",
      "if ! pg_isready -h \"$PGHOST\" -q 2>/dev/null; then echo 'PostgreSQLを起動しています...'; pg_ctl start -D \"$PGDATA\" -o \"-k '$PGHOST'\" -l \"$PGDATA/postgresql.log\" -w 2>/dev/null || (devbox services up --background 2>/dev/null; true); fi",
      "echo 'PostgreSQLの起動を待っています...'; for i in $(seq 1 60); do pg_isready -h \"$PGHOST\" -q && break; sleep 1; printf '.'; done; echo ''",
      "if ! psql -lqt -h \"$PGHOST\" 2>/dev/null | cut -d '|' -f 1 | grep -qw hackathon; then echo 'データベースを作成しています...'; createdb -h \"$PGHOST\" hackathon && echo 'Created database: hackathon'; fi",
      "if [ ! -f \"$PGDATA/.migration_applied\" ]; then echo 'マイグレーションを適用しています...'; psql -h \"$PGHOST\" hackathon -f backend/db/migrations/001_init.sql && touch \"$PGDATA/.migration_applied\" && echo 'Migration applied.'; fi"
    ],
    "scripts": {
      "db:setup": [
        "if ! psql -h \"$PGHOST\" -lqt 2>/dev/null | cut -d '|' -f 1 | grep -qw hackathon; then createdb -h \"$PGHOST\" hackathon && echo 'Created database: hackathon'; else echo 'Database hackathon already exists'; fi",
        "psql -h \"$PGHOST\" hackathon -f backend/db/migrations/001_init.sql && touch \"$PGDATA/.migration_applied\" && echo 'Migration applied.'"
      ],
      "backend:dev": [
        "cd backend && air"
      ],
      "backend:run": [
        "cd backend && go run ./cmd/server"
      ],
      "backend:build": [
        "cd backend && go build -o bin/server ./cmd/server"
      ],
      "frontend:dev": [
        "cd frontend && npm run dev"
      ],
      "frontend:install": [
        "cd frontend && npm install"
      ],
      "sqlc:generate": [
        "cd backend/db && sqlc generate"
      ]
    }
  }
}
