name: Backend Deploy

on:
  push:
    branches:
      - main
    paths:
      - "backend/**"

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup devbox
        uses: jetify-com/devbox-install-action@v0.12.0
        with:
          enable-cache: true
      - name: Format check
        run: devbox run -- sh -c "cd backend && gofmt -l . | tee /tmp/gofmt.out && [ ! -s /tmp/gofmt.out ]"

      - name: Lint
        run: devbox run -- sh -c "cd backend && golangci-lint run ./..."

      - name: Build
        run: devbox run -- sh -c "cd backend && go build -o bin/server ./cmd/server"

      - name: Test
        run: devbox run -- sh -c "cd backend && go test ./..."

  deploy:
    runs-on: ubuntu-latest
    needs: ci
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: backend/go.mod
          cache-dependency-path: backend/go.sum

      - name: Cross-compile for ARM64 (Raspberry Pi)
        working-directory: backend
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: "0"
        run: go build -o bin/server-arm64 ./cmd/server

      - name: Install cloudflared
        run: |
          curl -fsSL https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb -o cloudflared.deb
          sudo dpkg -i cloudflared.deb

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          RASPI_KNOWN_HOSTS: ${{ secrets.RASPI_KNOWN_HOSTS }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          echo "$RASPI_KNOWN_HOSTS" >> ~/.ssh/known_hosts

      - name: Transfer binary to Raspberry Pi
        env:
          RASPI_HOST: ${{ secrets.RASPI_HOST }}
          RASPI_USER: ${{ secrets.RASPI_USER }}
          CF_CLIENT_ID: ${{ secrets.CF_CLIENT_ID }}
          CF_CLIENT_SECRET: ${{ secrets.CF_CLIENT_SECRET }}
        run: |
          scp -o ProxyCommand="cloudflared access ssh --hostname $RASPI_HOST --id $CF_CLIENT_ID --secret $CF_CLIENT_SECRET" \
            -i ~/.ssh/id_ed25519 \
            backend/bin/server-arm64 \
            "$RASPI_USER@$RASPI_HOST:/opt/backend/server.new"

      - name: Deploy & restart service
        env:
          RASPI_HOST: ${{ secrets.RASPI_HOST }}
          RASPI_USER: ${{ secrets.RASPI_USER }}
          CF_CLIENT_ID: ${{ secrets.CF_CLIENT_ID }}
          CF_CLIENT_SECRET: ${{ secrets.CF_CLIENT_SECRET }}
        run: |
          ssh \
            -o ProxyCommand="cloudflared access ssh --hostname $RASPI_HOST --id $CF_CLIENT_ID --secret $CF_CLIENT_SECRET" \
            -i ~/.ssh/id_ed25519 \
            "$RASPI_USER@$RASPI_HOST" \
            'set -e
            mv /opt/backend/server.new /opt/backend/server
            chmod +x /opt/backend/server
            systemctl --user restart backend.service
            for i in $(seq 1 15); do
              if systemctl --user is-active --quiet backend.service; then
                echo "Service started successfully."
                exit 0
              fi
              sleep 1
            done
            echo "Service failed to start!" >&2
            journalctl --user -u backend.service --no-pager -n 30 >&2
            exit 1'
