name: Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  migrate:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Install goose
        run: go install github.com/pressly/goose/v3/cmd/goose@latest

      - name: Run backend migrations (goose)
        env:
          BACKEND_DIRECT_DATABASE_URL: ${{ secrets.BACKEND_DIRECT_DATABASE_URL }}
        run: goose -dir backend/db/migrations postgres "$BACKEND_DIRECT_DATABASE_URL" up

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: npm ci --prefix frontend

      - name: Run frontend migrations (drizzle-kit)
        working-directory: frontend
        env:
          DATABASE_URL: ${{ secrets.FRONTEND_DIRECT_DATABASE_URL }}
        run: npx drizzle-kit migrate

  deploy-backend:
    name: Deploy Backend to Cloud Run
    runs-on: ubuntu-latest
    needs: [migrate]
    if: always() && (needs.migrate.result == 'success' || needs.migrate.result == 'skipped')
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        env:
          GCP_REGION: ${{ secrets.GCP_REGION }}
        run: gcloud auth configure-docker "${GCP_REGION}-docker.pkg.dev" --quiet

      - name: Build Docker image
        env:
          GCP_REGION: ${{ secrets.GCP_REGION }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GIT_SHA: ${{ github.sha }}
        run: |
          IMAGE="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/backend/server:${GIT_SHA}"
          docker build -t "$IMAGE" ./backend

      - name: Push and deploy (main only)
        if: github.ref == 'refs/heads/main'
        env:
          GCP_REGION: ${{ secrets.GCP_REGION }}
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GIT_SHA: ${{ github.sha }}
          BACKEND_DATABASE_URL: ${{ secrets.BACKEND_DATABASE_URL }}
          BACKEND_REDIS_URL: ${{ secrets.BACKEND_REDIS_URL }}
          BACKEND_ALLOWED_ORIGINS: ${{ secrets.BACKEND_ALLOWED_ORIGINS }}
        run: |
          IMAGE="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/backend/server:${GIT_SHA}"
          docker push "$IMAGE"
          gcloud run deploy backend \
            --image "$IMAGE" \
            --region "$GCP_REGION" \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "DATABASE_URL=${BACKEND_DATABASE_URL},REDIS_URL=${BACKEND_REDIS_URL},SERVER_PORT=8080,ALLOWED_ORIGINS=${BACKEND_ALLOWED_ORIGINS}" \
            --quiet

  # deploy-frontend:
  #   name: Deploy Frontend to Cloudflare Pages
  #   runs-on: ubuntu-latest
  #   needs: [migrate, deploy-backend]
  #   if: always() && (needs.migrate.result == 'success' || needs.migrate.result == 'skipped') && needs.deploy-backend.result == 'success'
  #
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: 24
  #         cache: npm
  #         cache-dependency-path: frontend/package-lock.json
  #
  #     - name: Install dependencies
  #       run: npm ci --prefix frontend
  #
  #     - name: Build for Cloudflare
  #       working-directory: frontend
  #       env:
  #         GITHUB_ID: ${{ secrets.FRONTEND_GITHUB_ID }}
  #         GITHUB_SECRET: ${{ secrets.FRONTEND_GITHUB_SECRET }}
  #         AUTH_URL: ${{ secrets.FRONTEND_AUTH_URL }}
  #         NEXTAUTH_SECRET: ${{ secrets.FRONTEND_NEXTAUTH_SECRET }}
  #         GEMINI_API_KEY: ${{ secrets.FRONTEND_GEMINI_API_KEY }}
  #         DATABASE_URL: ${{ secrets.FRONTEND_DATABASE_URL }}
  #         NEXT_PUBLIC_BACKEND_URL: ${{ secrets.FRONTEND_BACKEND_URL }}
  #       run: npm run build:cf
  #
  #     - name: Deploy to Cloudflare Workers (main only)
  #       if: github.ref == 'refs/heads/main'
  #       working-directory: frontend
  #       env:
  #         CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
  #         CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  #       run: npx wrangler deploy
