name: Deploy to Raspberry Pi

on:
  push:
    branches: [main]

jobs:
  # 変更されたパスを検出して、必要なデプロイジョブだけを実行する
  filter:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
              - 'devbox.json'
              - 'devbox.lock'

  deploy-backend:
    needs: filter
    if: needs.filter.outputs.backend == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: devbox を PATH に追加
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: backend/.env を生成
        env:
          SERVER_PORT: ${{ secrets.BACKEND_SERVER_PORT }}
          DB_HOST: ${{ secrets.BACKEND_DB_HOST }}
          DB_PORT: ${{ secrets.BACKEND_DB_PORT }}
          DB_USER: ${{ secrets.BACKEND_DB_USER }}
          DB_PASSWORD: ${{ secrets.BACKEND_DB_PASSWORD }}
          DB_NAME: ${{ secrets.BACKEND_DB_NAME }}
          DB_SSLMODE: ${{ secrets.BACKEND_DB_SSLMODE }}
          REDIS_ADDR: ${{ secrets.BACKEND_REDIS_ADDR }}
          REDIS_PASSWORD: ${{ secrets.BACKEND_REDIS_PASSWORD }}
          REDIS_DB: ${{ secrets.BACKEND_REDIS_DB }}
        run: |
          {
            echo "SERVER_PORT=${SERVER_PORT:-8080}"
            echo "DB_HOST=${DB_HOST}"
            echo "DB_PORT=${DB_PORT:-5432}"
            echo "DB_USER=${DB_USER}"
            echo "DB_PASSWORD=${DB_PASSWORD}"
            echo "DB_NAME=${DB_NAME:-hackathon}"
            echo "DB_SSLMODE=${DB_SSLMODE:-disable}"
            echo "REDIS_ADDR=${REDIS_ADDR:-localhost:6379}"
            echo "REDIS_PASSWORD=${REDIS_PASSWORD}"
            echo "REDIS_DB=${REDIS_DB:-0}"
          } > backend/.env
          chmod 600 backend/.env

      - name: バックエンドをビルド
        run: devbox run -- sh -c "cd backend && go build -o /opt/backend/server ./cmd/server"

      - name: backend.service を再起動
        run: |
          export XDG_RUNTIME_DIR=/run/user/$(id -u)
          systemctl --user restart backend.service

      - name: ヘルスチェック
        run: |
          export XDG_RUNTIME_DIR=/run/user/$(id -u)
          for i in $(seq 1 15); do
            if systemctl --user is-active --quiet backend.service; then
              echo "backend.service is running."
              exit 0
            fi
            sleep 1
          done
          echo "backend.service failed to start!" >&2
          journalctl --user -u backend.service --no-pager -n 30 >&2
          exit 1

  deploy-frontend:
    needs: filter
    if: needs.filter.outputs.frontend == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: devbox を PATH に追加
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: frontend/.env を生成
        # GITHUB_ID は GitHub Actions の予約変数と衝突するため、Secret 名に FRONTEND_ プレフィックスを付ける
        # .env ファイルには元の変数名（GITHUB_ID）で書き込む
        env:
          FRONTEND_GITHUB_ID: ${{ secrets.FRONTEND_GITHUB_ID }}
          FRONTEND_GITHUB_SECRET: ${{ secrets.FRONTEND_GITHUB_SECRET }}
          FRONTEND_AUTH_URL: ${{ secrets.FRONTEND_AUTH_URL }}
          FRONTEND_NEXTAUTH_SECRET: ${{ secrets.FRONTEND_NEXTAUTH_SECRET }}
          FRONTEND_GEMINI_API_KEY: ${{ secrets.FRONTEND_GEMINI_API_KEY }}
        run: |
          {
            echo "GITHUB_ID=${FRONTEND_GITHUB_ID}"
            echo "GITHUB_SECRET=${FRONTEND_GITHUB_SECRET}"
            echo "AUTH_URL=${FRONTEND_AUTH_URL}"
            echo "NEXTAUTH_SECRET=${FRONTEND_NEXTAUTH_SECRET}"
            echo "GEMINI_API_KEY=${FRONTEND_GEMINI_API_KEY}"
          } > frontend/.env
          chmod 600 frontend/.env

      - name: 依存関係をインストール
        run: devbox run -- sh -c "cd frontend && npm ci --prefer-offline"

      - name: Next.js をビルド
        # raspi はメモリが少ないため --max-old-space-size で制限
        run: devbox run -- sh -c "cd frontend && NODE_OPTIONS='--max-old-space-size=512' npm run build"

      - name: frontend.service を再起動
        run: |
          export XDG_RUNTIME_DIR=/run/user/$(id -u)
          systemctl --user restart frontend.service

      - name: ヘルスチェック
        run: |
          export XDG_RUNTIME_DIR=/run/user/$(id -u)
          for i in $(seq 1 20); do
            if systemctl --user is-active --quiet frontend.service; then
              echo "frontend.service is running."
              exit 0
            fi
            sleep 1
          done
          echo "frontend.service failed to start!" >&2
          journalctl --user -u frontend.service --no-pager -n 50 >&2
          exit 1
