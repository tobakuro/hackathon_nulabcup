name: Deploy to Raspberry Pi

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: [self-hosted, Linux, ARM64, raspi]
    steps:
      - uses: actions/checkout@v4

      - name: backend/.env を生成
        env:
          SERVER_PORT: ${{ secrets.BACKEND_SERVER_PORT }}
          DB_HOST: ${{ secrets.BACKEND_DB_HOST }}
          DB_PORT: ${{ secrets.BACKEND_DB_PORT }}
          DB_USER: ${{ secrets.BACKEND_DB_USER }}
          DB_PASSWORD: ${{ secrets.BACKEND_DB_PASSWORD }}
          DB_NAME: ${{ secrets.BACKEND_DB_NAME }}
          DB_SSLMODE: ${{ secrets.BACKEND_DB_SSLMODE }}
          REDIS_ADDR: ${{ secrets.BACKEND_REDIS_ADDR }}
          REDIS_PASSWORD: ${{ secrets.BACKEND_REDIS_PASSWORD }}
          REDIS_DB: ${{ secrets.BACKEND_REDIS_DB }}
        run: |
          missing=()
          [ -z "${DB_HOST}" ]     && missing+=("BACKEND_DB_HOST")
          [ -z "${DB_USER}" ]     && missing+=("BACKEND_DB_USER")
          [ -z "${DB_PASSWORD}" ] && missing+=("BACKEND_DB_PASSWORD")
          if [ ${#missing[@]} -gt 0 ]; then
            echo "必須 Secret が未設定です: ${missing[*]}" >&2
            exit 1
          fi
          {
            echo "SERVER_PORT=${SERVER_PORT:-8080}"
            echo "DB_HOST=${DB_HOST}"
            echo "DB_PORT=${DB_PORT:-5432}"
            echo "DB_USER=${DB_USER}"
            echo "DB_PASSWORD=${DB_PASSWORD}"
            echo "DB_NAME=${DB_NAME:-hackathon}"
            echo "DB_SSLMODE=${DB_SSLMODE:-disable}"
            echo "REDIS_ADDR=${REDIS_ADDR:-redis:6379}"
            echo "REDIS_PASSWORD=${REDIS_PASSWORD}"
            echo "REDIS_DB=${REDIS_DB:-0}"
          } > backend/.env
          chmod 600 backend/.env

      - name: frontend/.env を生成
        env:
          FRONTEND_GITHUB_ID: ${{ secrets.FRONTEND_GITHUB_ID }}
          FRONTEND_GITHUB_SECRET: ${{ secrets.FRONTEND_GITHUB_SECRET }}
          FRONTEND_AUTH_URL: ${{ secrets.FRONTEND_AUTH_URL }}
          FRONTEND_NEXTAUTH_SECRET: ${{ secrets.FRONTEND_NEXTAUTH_SECRET }}
          FRONTEND_GEMINI_API_KEY: ${{ secrets.FRONTEND_GEMINI_API_KEY }}
          FRONTEND_DATABASE_URL: ${{ secrets.FRONTEND_DATABASE_URL }}
        run: |
          {
            echo "GITHUB_ID=${FRONTEND_GITHUB_ID}"
            echo "GITHUB_SECRET=${FRONTEND_GITHUB_SECRET}"
            echo "AUTH_URL=${FRONTEND_AUTH_URL}"
            echo "NEXTAUTH_SECRET=${FRONTEND_NEXTAUTH_SECRET}"
            echo "GEMINI_API_KEY=${FRONTEND_GEMINI_API_KEY}"
            echo "DATABASE_URL=${FRONTEND_DATABASE_URL}"
          } > frontend/.env
          chmod 600 frontend/.env

      - name: raspi/.env を生成（DB_PASSWORD）
        env:
          DB_PASSWORD: ${{ secrets.BACKEND_DB_PASSWORD }}
        run: |
          echo "DB_PASSWORD=${DB_PASSWORD}" > raspi/.env
          chmod 600 raspi/.env

      - name: podman の内部状態をリセット
        run: podman system migrate || true

      - name: 既存コンテナを停止
        working-directory: raspi
        run: podman compose down || true

      - name: コンテナイメージをビルド
        working-directory: raspi
        run: podman compose build

      - name: コンテナを起動
        working-directory: raspi
        run: podman compose up -d

      - name: 未使用イメージを削除
        run: podman image prune -f

      - name: コンテナ状態を確認
        working-directory: raspi
        run: |
          sleep 5
          podman compose ps
          # 全コンテナが running であることを確認
          podman compose ps --format json | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          if not isinstance(data, list):
              data = [data]
          failed = [c['Name'] for c in data if c.get('State') != 'running']
          if failed:
              print('以下のコンテナが running ではありません:', file=sys.stderr)
              print('\n'.join(failed), file=sys.stderr)
              sys.exit(1)
          print('全コンテナが正常に稼働しています')
          "
