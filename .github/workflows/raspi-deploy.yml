name: Deploy to Raspberry Pi

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: [self-hosted, Linux, ARM64, raspi]
    steps:
      - uses: actions/checkout@v4

      - name: backend/.env を生成
        env:
          SERVER_PORT: ${{ secrets.BACKEND_SERVER_PORT }}
          DB_HOST: ${{ secrets.BACKEND_DB_HOST }}
          DB_PORT: ${{ secrets.BACKEND_DB_PORT }}
          DB_USER: ${{ secrets.BACKEND_DB_USER }}
          DB_PASSWORD: ${{ secrets.BACKEND_DB_PASSWORD }}
          DB_NAME: ${{ secrets.BACKEND_DB_NAME }}
          DB_SSLMODE: ${{ secrets.BACKEND_DB_SSLMODE }}
          REDIS_ADDR: ${{ secrets.BACKEND_REDIS_ADDR }}
          REDIS_PASSWORD: ${{ secrets.BACKEND_REDIS_PASSWORD }}
          REDIS_DB: ${{ secrets.BACKEND_REDIS_DB }}
        run: |
          missing=()
          [ -z "${DB_HOST}" ]     && missing+=("BACKEND_DB_HOST")
          [ -z "${DB_USER}" ]     && missing+=("BACKEND_DB_USER")
          [ -z "${DB_PASSWORD}" ] && missing+=("BACKEND_DB_PASSWORD")
          if [ ${#missing[@]} -gt 0 ]; then
            echo "必須 Secret が未設定です: ${missing[*]}" >&2
            exit 1
          fi
          {
            echo "SERVER_PORT=${SERVER_PORT:-8080}"
            echo "DB_HOST=${DB_HOST}"
            echo "DB_PORT=${DB_PORT:-5432}"
            echo "DB_USER=${DB_USER}"
            echo "DB_PASSWORD=${DB_PASSWORD}"
            echo "DB_NAME=${DB_NAME:-hackathon}"
            echo "DB_SSLMODE=${DB_SSLMODE:-disable}"
            echo "REDIS_ADDR=${REDIS_ADDR:-redis:6379}"
            echo "REDIS_PASSWORD=${REDIS_PASSWORD}"
            echo "REDIS_DB=${REDIS_DB:-0}"
          } > backend/.env
          chmod 600 backend/.env

      - name: frontend/.env を生成
        env:
          FRONTEND_GITHUB_ID: ${{ secrets.FRONTEND_GITHUB_ID }}
          FRONTEND_GITHUB_SECRET: ${{ secrets.FRONTEND_GITHUB_SECRET }}
          FRONTEND_AUTH_URL: ${{ secrets.FRONTEND_AUTH_URL }}
          FRONTEND_NEXTAUTH_SECRET: ${{ secrets.FRONTEND_NEXTAUTH_SECRET }}
          FRONTEND_GEMINI_API_KEY: ${{ secrets.FRONTEND_GEMINI_API_KEY }}
          FRONTEND_DATABASE_URL: ${{ secrets.FRONTEND_DATABASE_URL }}
        run: |
          {
            echo "GITHUB_ID=${FRONTEND_GITHUB_ID}"
            echo "GITHUB_SECRET=${FRONTEND_GITHUB_SECRET}"
            echo "AUTH_URL=${FRONTEND_AUTH_URL}"
            echo "NEXTAUTH_SECRET=${FRONTEND_NEXTAUTH_SECRET}"
            echo "GEMINI_API_KEY=${FRONTEND_GEMINI_API_KEY}"
            echo "DATABASE_URL=${FRONTEND_DATABASE_URL}"
          } > frontend/.env
          chmod 600 frontend/.env

      - name: raspi/.env を生成（DB_PASSWORD）
        env:
          DB_PASSWORD: ${{ secrets.BACKEND_DB_PASSWORD }}
        run: |
          echo "DB_PASSWORD=${DB_PASSWORD}" > raspi/.env
          chmod 600 raspi/.env

      - name: Docker イメージをビルド
        run: docker compose -f raspi/compose.yml build

      - name: コンテナを起動
        run: docker compose -f raspi/compose.yml up -d

      - name: 未使用イメージを削除
        run: docker image prune -f

      - name: コンテナ状態を確認
        run: |
          sleep 5
          docker compose -f raspi/compose.yml ps
          # 全コンテナが running であることを確認
          not_running=$(docker compose -f raspi/compose.yml ps --format json | jq -r 'select(.State != "running") | .Name')
          if [ -n "${not_running}" ]; then
            echo "以下のコンテナが running ではありません:" >&2
            echo "${not_running}" >&2
            docker compose -f raspi/compose.yml logs --tail=50 >&2
            exit 1
          fi
          echo "全コンテナが正常に稼働しています"
